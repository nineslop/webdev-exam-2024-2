{% extends 'base.html' %}
{% block content %}
<h2>Список книг</h2>
<div class="book-list">
    {% for book in books.items %}
    <div class="book-item card mb-3">
        <div class="card-body">
            <h3 class="card-title">{{ book.title }}</h3>
            <p class="card-text">Год: {{ book.year }}</p>
            <p class="card-text">Жанры: {% for genre in book.genres %}{{ genre.name }} {% endfor %}</p>
            <p class="card-text">Средняя оценка: {{ book.reviews.with_entities(func.avg(Review.rating)).scalar() }}</p>
            <p class="card-text">Количество рецензий: {{ book.reviews.count() }}</p>
            <a href="{{ url_for('book_detail', book_id=book.id) }}" class="btn btn-primary">Просмотр</a>
            {% if current_user.is_authenticated and current_user.role and (current_user.role.name == 'admin' or current_user.role.name == 'moderator') %}
                <a href="{{ url_for('edit_book', book_id=book.id) }}" class="btn btn-secondary">Редактировать</a>
            {% endif %}
            {% if current_user.is_authenticated and current_user.role and current_user.role.name == 'admin' %}
                <form action="{{ url_for('delete_book', book_id=book.id) }}" method="POST" style="display:inline;">
                    <button type="submit" class="btn btn-danger">Удалить</button>
                </form>
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>
<div class="pagination mt-3">
    {% if books.has_prev %}
        <a href="{{ url_for('index', page=books.prev_num) }}" class="btn btn-secondary">Предыдущая</a>
    {% endif %}
    <span class="mx-2">Страница {{ books.page }} из {{ books.pages }}</span>
    {% if books.has_next %}
        <a href="{{ url_for('index', page=books.next_num) }}" class="btn btn-secondary">Следующая</a>
    {% endif %}
</div>
{% if current_user.is_authenticated and current_user.role and current_user.role.name == 'admin' %}
    <a href="{{ url_for('add_book') }}" class="btn btn-success mt-3">Добавить книгу</a>
{% endif %}
{% endblock %}
